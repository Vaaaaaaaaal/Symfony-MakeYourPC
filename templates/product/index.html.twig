{% extends 'base.html.twig' %}

{% block title %}Nos Produits - MakeYourPC{% endblock %}

{% block body %}
    <div class="container">
        <h1 class="my-4">Nos Produits</h1>
        
        <div class="search-bar mb-4">
            <form action="{{ path('app_products') }}" method="GET" class="form-inline">
                <div class="search-container">
                    <input type="text" name="search" class="form-control" placeholder="Rechercher un produit..." value="{{ app.request.query.get('search') }}">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="submit">Rechercher</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="product-container">
            <div class="filters sticky-filters">
                <h4>Filtres</h4>
                <form action="{{ path('app_products') }}" method="GET">
                    <div class="form-group number-input-container">
                        <label for="price_min">Prix min</label>
                        <input type="number" class="input-int" id="price_min" name="price_min" value="{{ app.request.query.get('price_min') }}">
                    </div>
                    <div class="form-group number-input-container">
                        <label for="price_max">Prix max</label>
                        <input type="number" class="input-int" id="price_max" name="price_max" value="{{ app.request.query.get('price_max') }}">
                    </div>
                    <div class="form-group">
                        <label for="type">Type de produit</label>
                        <select class="form-control" id="type" name="type">
                            <option value="">Tous</option>
                            <option value="cpu" {% if app.request.query.get('type') == 'cpu' %}selected{% endif %}>CPU</option>
                            <option value="gpu" {% if app.request.query.get('type') == 'gpu' %}selected{% endif %}>GPU</option>
                            <option value="ssd" {% if app.request.query.get('type') == 'ssd' %}selected{% endif %}>SSD</option>
                            <option value="motherboard" {% if app.request.query.get('type') == 'motherboard' %}selected{% endif %}>Carte mère</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rating">Note minimale</label>
                        <select class="form-control" id="rating" name="rating">
                            <option value="">Toutes les notes</option>
                            <option value="4" {% if app.request.query.get('rating') == '4' %}selected{% endif %}>4 étoiles et plus</option>
                            <option value="3" {% if app.request.query.get('rating') == '3' %}selected{% endif %}>3 étoiles et plus</option>
                            <option value="2" {% if app.request.query.get('rating') == '2' %}selected{% endif %}>2 étoiles et plus</option>
                            <option value="1" {% if app.request.query.get('rating') == '1' %}selected{% endif %}>1 étoile et plus</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">Appliquer les filtres</button>
                </form>
            </div>
            
            <div class="product-grid">
                {% if products is empty %}
                    <div class="no-products-message">
                        <p>Aucun produit ne correspond à votre recherche.</p>
                        <p>Essayez de modifier vos critères de recherche ou de réinitialiser les filtres.</p>
                    </div>
                {% else %}
                    {% for product in products %}
                        <div class="product-tile" data-product-id="{{ product.id }}">
                            <img src="{{ asset('images/products/' ~ product.imagePath) }}" alt="{{ product.name }}">
                            <h4>{{ product.name }}</h4>
                            <div class="rating">
                                {% for i in 1..5 %}
                                    {% if i <= product.rating %}
                                        <i data-lucide="star" class="star filled"></i>
                                    {% elseif i <= product.rating + 0.5 %}
                                        <i data-lucide="star-half" class="star filled"></i>
                                    {% else %}
                                        <i data-lucide="star" class="star"></i>
                                    {% endif %}
                                {% endfor %}
                                <span class="rating-value ml-2">{{ product.rating|number_format(1) }}</span>
                            </div>
                            <div class="price-card">{{ product.price|number_format(2, ',', ' ') }} €</div>
                            <p class="type">{{ product.type }}</p>
                            <button class="btn-add-to-cart" type="button" data-product-id="{{ product.id }}">
                                <i data-lucide="shopping-cart"></i>
                            </button>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const addToCartButtons = document.querySelectorAll('.btn-add-to-cart');
            
            addToCartButtons.forEach(button => {
                button.replaceWith(button.cloneNode(true));
                
                const newButton = document.querySelector(`.btn-add-to-cart[data-product-id="${button.dataset.productId}"]`);
                
                newButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (this.disabled) return;
                    
                    const productId = this.dataset.productId;
                    this.disabled = true;
                    
                    fetch(`/cart/add/${productId}`, {
                        method: 'POST',
                        headers: {
                            'X-CSRF-TOKEN': '{{ csrf_token('add-to-cart') }}',
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(err.message || 'Erreur serveur');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            const cartCount = document.querySelector('.cart-count');
                            if (cartCount) {
                                cartCount.textContent = data.cartCount;
                                cartCount.style.display = data.cartCount > 0 ? 'inline-block' : 'none';
                            }
                            showNotification('Produit ajouté au panier', 'success');
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        showNotification('Erreur lors de l\'ajout au panier', 'error');
                    })
                    .finally(() => {
                        this.disabled = false;
                    });
                }, { once: true });
            });
        });

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            lucide.createIcons();
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
{% endblock %}
