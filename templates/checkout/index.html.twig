{% extends 'base.html.twig' %}

{% block title %}Paiement - MakeYourPC{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/checkout.js') }}"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Formatage du numéro de carte
        const cardNumberInput = document.querySelector('[data-checkout-field="cardNumber"]');
        cardNumberInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 16) value = value.slice(0, 16);
            
            // Format XXXX XXXX XXXX XXXX
            const parts = [];
            for (let i = 0; i < value.length; i += 4) {
                parts.push(value.slice(i, i + 4));
            }
            e.target.value = parts.join(' ');
        });

        // Formatage de la date d'expiration
        const expiryInput = document.querySelector('[data-checkout-field="cardExpiry"]');
        expiryInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 4) value = value.slice(0, 4);
            
            // Format MM/YY
            if (value.length >= 2) {
                const month = value.slice(0, 2);
                const year = value.slice(2);
                if (parseInt(month) > 12) value = '12' + year;
                e.target.value = month + (year.length ? '/' + year : '');
            } else {
                e.target.value = value;
            }
        });

        // Formatage du CVC
        const cvcInput = document.querySelector('[data-checkout-field="cardCvc"]');
        cvcInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 3) value = value.slice(0, 3);
            e.target.value = value;
        });
    });
    </script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/checkout.css') }}">
    <style>
        .error-message {
            font-size: 0.875rem;
        }
        .is-invalid {
            border-color: #dc3545 !important;
        }
        .is-valid {
            border-color: #198754 !important;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container">
        <h1 class="my-4">Finaliser votre commande</h1>

        <div class="checkout-container">
            <div class="checkout-form">
                {{ form_start(form, {'attr': {'class': 'needs-validation'}}) }}
                    <div class="personal-info">
                        <h2>Informations personnelles</h2>
                        <div class="form-row">
                            <div class="form-group">
                                {{ form_row(form.firstName) }}
                            </div>
                            <div class="form-group">
                                {{ form_row(form.lastName) }}
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                {{ form_row(form.email) }}
                            </div>
                            <div class="form-group">
                                {{ form_row(form.phone) }}
                            </div>
                        </div>
                    </div>

                    <div class="shipping-info mt-4">
                        <h2>Adresse de livraison</h2>
                        
                        {% if app.user %}
                            <div class="form-group mb-4">
                                {{ form_row(form.savedAddress, {'attr': {'class': 'form-control'}}) }}
                            </div>
                        {% endif %}

                        <div class="form-group">
                            {{ form_row(form.address) }}
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                {{ form_row(form.city) }}
                            </div>
                            <div class="form-group col-md-6">
                                {{ form_row(form.postalCode) }}
                            </div>
                        </div>
                    </div>

                    <div class="payment-info mt-4">
                        <h2>Informations de paiement</h2>
                        <div class="form-group">
                            {{ form_label(form.cardNumber) }}
                            {{ form_widget(form.cardNumber, {
                                'attr': {
                                    'class': 'form-control',
                                    'autocomplete': 'cc-number',
                                    'data-checkout-field': 'cardNumber'
                                }
                            }) }}
                            <div class="invalid-feedback">
                                Numéro de carte invalide
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                {{ form_label(form.cardExpiry) }}
                                {{ form_widget(form.cardExpiry, {
                                    'attr': {
                                        'class': 'form-control',
                                        'autocomplete': 'cc-exp',
                                        'data-checkout-field': 'cardExpiry'
                                    }
                                }) }}
                                <div class="invalid-feedback">
                                    Date d'expiration invalide
                                </div>
                            </div>
                            <div class="form-group col-md-6">
                                {{ form_label(form.cardCvc) }}
                                {{ form_widget(form.cardCvc, {
                                    'attr': {
                                        'class': 'form-control',
                                        'autocomplete': 'cc-csc',
                                        'data-checkout-field': 'cardCvc'
                                    }
                                }) }}
                                <div class="invalid-feedback">
                                    Code CVC invalide
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-checkout mt-4" id="submit-payment">
                        Valider le paiement
                        <i data-lucide="credit-card"></i>
                    </button>
                {{ form_end(form) }}
            </div>

            <div class="order-summary">
                <h2>Récapitulatif de la commande</h2>
                <div class="cart-items">
                    {% set total = 0 %}
                    {% for item in cart.items %}
                        {% set itemTotal = item.product.price * item.quantity %}
                        {% set total = total + itemTotal %}
                        <div class="cart-item">
                            <div class="item-details">
                                <h4>{{ item.product.name }}</h4>
                                <p>Quantité: {{ item.quantity }}</p>
                                <p>Prix unitaire: {{ item.product.price|number_format(2, ',', ' ') }} €</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div class="cart-total">
                    <h3>Total</h3>
                    <div class="item-total">
                        {{ total|number_format(2, ',', ' ') }} €
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %} 